# GitHub Actions ä¸Šã§ã®åå‰
name: BuildActionToNetlify_PR

# èµ·å‹•æ¡ä»¶
on:
  workflow_dispatch: # GithubActionsä¸Šã§å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  pull_request:
#    branches:
#      - main        # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã§èµ°ã‚‰ã›ã‚‹ãŸã‚ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Netlify CLI
        run: |
          echo "::group::Install Netlify CLI"
          npm install -g netlify-cli
          echo "::endgroup::"

      - name: Deploy to netlify
        run: |
          echo "::group::Deploy to Netlify"
          # ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ç›´æ¥ãƒ‡ãƒ—ãƒ­ã‚¤
          netlify deploy --dir . --build > cli.txt
          echo "::endgroup::"
        env:
          NETLIFY_SITE_ID   : ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Post Netlify CLI Comment
        run: |
          echo "::group::Post Netlify CLI Comment"
          # èªè¨¼æƒ…å ±ã‚’å«ã‚€è¡Œã‚’é™¤å¤–ã—ã¦URLã‚’æŠ½å‡º
          DEPLOY_URL=$(grep "Website draft URL:" cli.txt | sed 's|.*: \(.*\)|\1|')
          BUILD_LOG_URL=$(grep "Build logs:" cli.txt | sed 's|.*: \(.*\)|\1|')
          FUNCTION_LOG_URL=$(grep "Function logs:" cli.txt | sed 's|.*: \(.*\)|\1|')
          
          # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
          PREVIEW_SECTION="## ğŸš€ Preview Links
          
          - [ğŸ“± Preview Site]($DEPLOY_URL)
          - [ğŸ“‹ Build Logs]($BUILD_LOG_URL)
          - [âš™ï¸ Function Logs]($FUNCTION_LOG_URL)

          \`\`\`
          Preview URL: $DEPLOY_URL
          \`\`\`"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã®ãƒ­ã‚°ã‚’æŠ½å‡ºï¼ˆèªè¨¼æƒ…å ±ã‚’é™¤å¤–ï¼‰
          DEPLOY_INFO=$(grep -v "NETLIFY_" cli.txt | grep -v "token" | grep -v "auth" | head -n 5)
          
          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
          COMMENT_BODY="$PREVIEW_SECTION

          <details>
          <summary>Deploy Information</summary>

          \`\`\`
          $DEPLOY_INFO
          \`\`\`
          </details>"
          
          # GitHubã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          JSON_BODY=$(jq -n --arg body "$COMMENT_BODY" '{"body": $body}')
          curl -X POST \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$JSON_BODY" \
            "${URL}"
          echo "::endgroup::"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          URL: ${{ github.event.pull_request.comments_url }}

      - name: Set AdSense ID
        run: |
          sed -i 's/\${NEXT_PUBLIC_ADSENSE_ID}/${{ secrets.NEXT_PUBLIC_ADSENSE_ID }}/g' index.html
          sed -i 's/\${NEXT_PUBLIC_REDIRECT_URL}/${{ secrets.NEXT_PUBLIC_REDIRECT_URL }}/g' index.html
